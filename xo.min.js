const hash=e=>[...e].reduce(((e,t)=>(e=(e<<5)-e+t.charCodeAt(0))&e),0).toString(32),type=(e,t)=>void 0!==t?Object.defineProperty(e,Symbol.for("type"),{value:t}):null==e?"none":e[Symbol.for("type")]?e[Symbol.for("type")]:e.constructor===Object||Array.isArray(e)?"collection":typeof e,undef=e=>void 0===e,exec=e=>"function"==typeof e?e():e,eq=(e,t)=>{if(e===t)return!0;if("object"!=typeof e||"object"!=typeof t)return!1;const o=Object.keys(e),n=Object.keys(t);return o.length===n.length&&o.every((o=>eq(e[o],t[o])))},cx=(...e)=>e.flatMap((e=>e&&e.constructor===Object?Object.keys(e).filter((t=>!!e[t])):e)).join(" "),Blueprint={cache:{},parse(e,t=""){const o=Array.isArray(e)?e.join(t):e,n=hash(o);if(Blueprint.cache[n])return Blueprint.cache[n];const r=document.createElement("template");if(r.innerHTML=o,r.slots=[],r.key=n,1!==r.content.children.length)throw new Error(`Blueprint has more than 1 top-level element: ${r.innerHTML}`);const c=(e,o=[])=>{if([...e.attributes].filter((({name:e,value:o})=>o===t)).forEach((({name:t,value:n})=>{e.removeAttribute(t),r.slots.push({attr:t,path:o})})),1===e.childNodes.length&&e.firstChild.textContent.trim()===t)return e.removeChild(e.firstChild),void r.slots.push({attr:"innerHTML",path:o});for(let n=0;n<e.childNodes.length;n++){let s=e.childNodes[n];if("#text"!==s.nodeName)c(s,o.concat(n));else if(s.textContent.includes(t)){const e=s.textContent.split(new RegExp(`(${t})`,"g")).map(((e,c)=>e!==t?e:(r.slots.push({attr:"innerHTML",path:o.concat(n+c)}),document.createElement("span"))));s.replaceWith(...e),n+=e.length-1}}};return c(r.content.firstElementChild),Blueprint.cache[n]=r,r},create:(e,...t)=>type({blueprint:Blueprint.parse(e),data:t},"blueprint"),render(e,t){const o=e.content.firstElementChild.cloneNode(!0);return t.replaceWith(o),o.slots=e.slots.map((({attr:e,path:t})=>({attr:e,last:null,el:t.reduce(((e,t)=>e.childNodes[t]),o)}))),o.key=e.key,o},update:({data:e,blueprint:t},o)=>(o.key!==t.key&&(o=Blueprint.render(t,o)),o.slots=o.slots.map(((t,o)=>(t.last!==e[o]&&(t.last=e[o],t.el=render(e[o],t.el,t.attr)),t))),o)},Component={cache:new WeakMap,create(e){const t=hash(e.toString());return(...o)=>type({args:o,key:t,func:e},"component")},makeInstance(e,t){let o={...e,hooks:[],observer:new MutationObserver((e=>e.map((({removedNodes:e})=>e.forEach((e=>Component.unmount(e))))))),scope:{el:t,useState(e){const t=o.hooks.counter++;return o.hooks[t]||(o.hooks[t]=[exec(e),e=>{eq(e,o.hooks[t][0])||(o.hooks[t][0]=e,o.scope.redraw())}]),o.hooks[t]},useMemo(e,t=!0){const n=o.hooks.counter++;return eq(t,o.hooks[n]?.dep)||(o.hooks[n]={val:e,dep:t}),o.hooks[n].val},useEffect(e,t=!0){const n=o.hooks.counter++;o.hooks[n]||(o.hooks[n]={}),eq(t,o.hooks[n].dep)||(exec(o.hooks[n].undo),o.hooks[n]={func:e,dep:t,flag:!0})},useInit(e){const t=o.hooks.counter++;return o.hooks[t]||(o.hooks[t]={undo:exec(e)}),o.hooks[t].undo},redraw(){o.pending||(o.pending=window.requestAnimationFrame((()=>Component.render(o.scope.el))))}}};return o},mount(e,t){t=Component.unmount(t);let o=Component.makeInstance(e,t);Component.cache.set(t,o);const n=Component.render(t);return o.observer.observe(n.parentNode,{childList:!0}),n},unmount(e){let t=Component.cache.get(e);return t?(window.cancelAnimationFrame(t.pending),t.observer.disconnect(),t.hooks.forEach((e=>exec(e.undo))),Component.cache.delete(e),e):e},render(e){if(!e.isConnected)return Component.unmount(e);let t=Component.cache.get(e);if(!t)return e;t.hooks.counter=0,t.pending=!1;const o=render(t.func.apply(t.scope,t.args),e);return o!==e&&(t.scope.el=o,Component.cache.set(o,t),Component.cache.delete(e)),t.hooks.filter((({flag:e})=>e)).forEach((e=>{exec(e.undo),e.undo=e.func(),e.flag=!1})),o},update(e,t){let o=Component.cache.get(t);return o&&e.key===o.key?eq(e.args,o.args)?t:(o.args=e.args,Component.render(t)):Component.mount(e,t)}},UpdateCollection=(e,t)=>{const o=Object.keys(e),n=t.collection_keys??[];if(!eq(o,n)){let r={};n.filter(((o,n)=>(r[o]=t.childNodes[n],void 0===e[o]))).forEach((e=>t.removeChild(r[e]))),o.forEach(((e,o)=>{r[e]&&r[e]===t.childNodes[o]||t.insertBefore(r[e]??document.createElement("span"),t.childNodes[o])})),t.collection_keys=o}return o.forEach(((o,n)=>render(e[o],t.childNodes[n]))),t},UpdateDOM=(e,t,o="innerHTML")=>("class"===o?t.classList=e:"innerHTML"===o?t.innerHTML=(e??"").toString():"boolean"==typeof e?t.toggleAttribute(o,e):t[o]=e,t),render=(e,t,o="innerHTML")=>"component"===type(e)?Component.update(e,t):"blueprint"===type(e)?Blueprint.update(e,t):"innerHTML"===o&&"collection"===type(e)?UpdateCollection(e,t):UpdateDOM(e,t,o);let xo={render:(e,t)=>render(e,t??document.body.firstElementChild),comp:Component.create,x:Blueprint.create,cx:cx};"undefined"==typeof window&&(xo.x=(e,...t)=>type({html:e,data:t},"blueprint"),xo.comp=e=>e.bind({useState:e=>[exec(e),()=>{}],useEffect:()=>{},useMemo:e=>e,useSignal:e=>exec(e),redraw:()=>{},el:{}}),xo.render=e=>"blueprint"===type(e)?e.html.reduce(((t,o,n)=>t+o+xo.render(e.data[n])),""):"collection"===type(e)?Object.values(e).map(xo.render).join("\n"):"function"===type(e)?'""':e??""),module.exports=xo;